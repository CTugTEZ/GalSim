\documentclass[a4paper,11pt]{article}
\usepackage[a4paper,
            inner=30mm,
            outer=30mm,% = marginparsep + marginparwidth 
                       %   + 5mm (between marginpar and page border)
            top=20mm,
            bottom=25mm,
            marginparsep=5mm,
            marginparwidth=40mm,
            %showframe% for show your page design, normaly not used
            ]{geometry}
% PACKAGES AND MARGINS:
\usepackage[english]{babel}
\usepackage[]{units}
\usepackage{csquotes}
\usepackage{rotating}
\usepackage{tikz}
\usepackage[titletoc,title]{appendix}
\usepackage[scientific-notation=true]{siunitx}
\sisetup{round-mode=places,round-precision=1}
\def\appendixautorefname{Appendix}
\MakeOuterQuote{"}
\usepackage[breaklinks,colorlinks,citecolor=blue,linkcolor=blue]{hyperref}
\renewcommand*{\sectionautorefname}{Section}
\providecommand{\e}[1]{\ensuremath{\times 10^{#1}}}
%\usepackage[all]{hypcap}
%\usepackage[margin=0.9in]{geometry}
%\usepackage{geometry}
 %\geometry{a4paper,total={210mm,297mm},left=20mm,right=20mm,top=25mm,bottom=20m} 
\usepackage[round]{natbib}   % omit 'round' option if you prefer square brackets
%\bibliographystyle{plainnat}
%\bibliographystyle{plain}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage{titling} % Set position and space of title
\linespread{1.2}
\setlength{\droptitle}{-10em}   % This is your set screw
\title{Reducing AEGIS galaxies in two filters}
\author{Sowmya Kamath, Joshua Meyers, Patricia Burchat}
%\date{\vspace{-5ex}}
\date{\today}
\begin{document}
\maketitle
\section{Introduction}
Gravitational weak-lensing is a useful tool in cosmology and requires statistical precision and accuracy in galaxy shape measurements. The chromatic nature of the point spread function (PSF) and the varying SED across a galaxy profile can create additional complications in measuring the intrinsic shape of the observed galaxy. Hence to better understand chromatic effects on galaxy shapes measured by LSST, it is necessary to simulate galaxy images that reflect the chromatic components of  real galaxies rather than only parametric models. 

We can use real galaxy images observed by HST in multiple filters to create real chromatic galaxies as seen by LSST, as implemented by Josh Meyers as {\tt ChromaticRealGalaxies} in {\tt GalSim} (see Github
\href{https://github.com/GalSim-developers/GalSim/issues/640}{issue}, 
\href{https://github.com/GalSim-developers/GalSim/pull/687}{pull request},
and 
\href{https://github.com/GalSim-developers/GalSim/blob/\%23640/devel/modules/CGNotes.pdf}{note}). 
In this document, we describe the procedure used to obtain postage-stamp images of individual galaxies from 
\href{http://aegis.ucolick.org/tech_overview.html}{AEGIS} 
(All-sky Extended Groth strip International Survey) in two HST filters (V and I). The method used to reduce the images is similar to the method used  to reduce COSMOS images \citep{Leauthaud2007}, and is an extension of work done by Bradley Emi, Rachel Mandelbaum, Andres Plaza, and Jason Rhodes in 2015 
(\href{https://github.com/bradleyemi/ChromaticGalaxies}{ChromaticGalaxies Github}). The \href{https://github.com/sowmyakth/true_gal_colors}{script} developed for image reduction is explained in a \href{https://github.com/GalSim-developers/GalSim/blob/\%23770/devel/external/AEGIS/README.md}{README} file \footnote{https://github.com/GalSim-developers/GalSim/blob/\%23770/devel/external/AEGIS/README.md}.

The work is presented as follows. In \autoref{sec:data set} we discuss the AEGIS HST data set used. The image reduction procedure is described in \autoref{sec:procedure}. The resulting two-band galaxy catalog and images are described in \autoref{sec:data} and analyzed in \autoref{sec:analysis}. 

\section{Input Data Set}
We use unrotated ACS/WFC data, that was already reduced, to create the catalog. To model the PSF, we use star fields drawn from {\tt Tiny Tim} software.  
\label{sec:data set}
\subsection{AEGIS HST data}
For the AEGIS HST imaging, a mosaic pattern consisting of $21 \times 3 = 63$ contiguous HST "tiles" was used to cover an effective area of $âˆ¼10.1'\times 70.5' = 710.9$ arcmin$^2$. Each tile was observed in a 4-pointing dither pattern in each of two filters (V and I), in order to achieve half-pixel dithering at the center of the ACS WFC, bridge the detector gap, and improve tile overlap. For each of the 63 tiles, there is a science image and a weight map \citep{Davis2006}.

\subsection{Science Image and Weight Map}
Each reduced image has been drizzled from 4 exposures to produce final $8000 \times 8000$ pixel images with pixel sampling of $0.03''$ per pixel~\citep{Lotz2008}.  The total exposure times and ABMAG and VEGA zero-points (see \href{http://aegis.ucolick.org/stored_pages/README}{AEGIS Imaging Data README}) are shown in \autoref{table:bandpass}.

%----------------------------------
\begin{table}[htb]
\centering
\caption{Parameters for images in V and I bands.}
\label{table:bandpass}
\begin{tabular}{cccc}
\hline
\hline
Filter & Total exposure time & ABMAG zero-point & VEGA zero-point \\
\hline
 F606W (V)  &  2260\,s  & 26.486  & 26.396\\
 F814W (I)  &  2100\,s  & 25.937  & 25.501 \\
\end{tabular}
\end{table}
%----------------------------------

The dithered observations for each pointing and filter were combined ("drizzled") using 
\href{http://stsdas.stsci.edu/multidrizzle}{MultiDrizzle}. 
The pixel drop size was 0.8 of the input pixel size, and the 
final pixel size of $0.03''$ is 0.6 of the input pixel size of $0.05''$.
These pixel sizes have been shown to reduce stochastic aliasing of the PSF~\citep{Rhodes}. 
An impact of the smaller pixel scale is increased correlation in the background noise in the final drizzled image. 
The MultiDrizzle algorithm also produces inverse-variance ($1/{\rm RMS}^2$) weight maps for each drizzled image. The weight maps include the effects of non-uniform exposure times for the "gaps" between the ACS chips and for masked cosmic-rays. The weight maps were converted to RMS maps ($\rm \sqrt[2]{\rm 1/WEIGHT\_MAP}$) for SExtractor measurements (see Appendix \autoref{App:weight}).

\subsection{{\tt Tiny Tim} Star Field}
The variation in the size and ellipticity of the PSF across the focal plane of the HST ACS is dominated by the effective focus, which changes due to thermal expansion and contraction of the HST. The {\tt Tiny Tim} ray-tracing software simulates the variation of the PSF across the field for different focal lengths. The PSF variation across an image is characterized by comparing the measured PSF ellipticity for stars in a field to the {\tt Tiny Tim} predictions for different focus offsets, and finding the focus that best matches the measured and predicted PSFs across the field~\citep{Leauthaud2007}.

\section{Catalog construction Procedure}
\label{sec:procedure}
The procedure used is similar to that used to create the weak lensing catalog for the HST ACS COSMOS survey~\citep{Leauthaud2007}. 
We use version 2.8.6 of the \href{http://www.astromatic.net/software/sextractor}{SExtractor} package to produce a source catalog of positions and various photometric parameters. A summary of the various steps in the construction of the catalog and the number of objects relevant to each step are shown in \autoref{table:count_all}.
%----------------------------------
\begin{table}[htb]
\centering
\caption{Summary of steps in construction of catalog.}
\label{table:count_all}
\resizebox{\textwidth}{!}{\begin{tabular}{lcc}
\hline
\hline
Parameter & V band & I band \\
\hline
 \multicolumn{3}{c}{Raw SExtractor Detections on Co-added V+I Image}\\
 \hline
 Total number of detected objects  & \multicolumn{2}{c} {\num{165419}} \\
 Total number of faint detections  & 
 \multicolumn{2}{c} {\num{147344}}\\
 Total number of bright detections  &  \multicolumn{2}{c} {\num{18075}}  \\
\hline
 \multicolumn{3}{c}{Details of Cleaning Process}\\
 \hline
 Number of objects within noisy border of tile  & 
 \multicolumn{2}{c} {\num{9029}}\\
 Number of faint detections with central pixel in bright segmentation map  & 
 \multicolumn{2}{c}{\num{18439}} \\
 Number of objects in diffraction masks  &  \num{1253}  & \num{1655}\\
 Number of objects in manual masks  &
 \multicolumn{2}{c}{\num{596}}\\
 Number of objects detected more than once in adjacent tiles  &
 \multicolumn{2}{c}{\num{2502}}\\
\hline
  \multicolumn{3}{c}{Catalog Cleaned of Image Defects}\\
 \hline
 Total number of objects  &  \num{136249}  & \num{135891}\\
 Number of galaxies  &  \num{134993}  & \num{134313}\\
 Number of stars  &  \num{1256}  & \num{1578}\\
\hline
 \multicolumn{3}{c}{Final Catalog with $\rm F814W_{AB}<25.2$}\\
 \hline
 Total number of objects in final catalog &  
 \multicolumn{2}{c} {\num{29105}}\\
\hline
 \multicolumn{3}{c}{Remove bad postage stamps }\\
 \hline
 Total number of objects that pass the cuts &  \num{27392}  & \num{27726}\\
 \hline
 \hline
\end{tabular}}
\end{table}
%----------------------------------

\subsection{Detection in Co-added Images}
We use SExtractor in dual-image mode, detecting objects with the summed V+I images and then performing photometry on the individual V and I images. This ensures that the catalogs have the same objects in both bands. 

The input RMS map corresponding to the co-added image was created by taking the reciprocal of the weight maps in both bands, adding them and then taking the square root of each pixel.

\subsection{"Hot-Cold" Detection Method}
To construct a catalog of objects useful for weak-lensing studies, 
we must be efficient in detecting the small faint objects that contain much of the lensing signal. 
We therefore configure SExtractor with very low detection thresholds (even if this leads to false detections) and apply selection criteria to clean the catalog later. 
However, when configured with low detection thresholds, SExtractor inevitably deblends low surface brightness spirals and patchy irregulars, detects spurious objects in the scattered light around bright objects, and under-deblends overlapping pairs of objects. To remedy these problems we adopt the method used by ~\citep{Leauthaud2007}, which was an improvement upon the "Hot-Cold" method used in the GEMS survey data analysis ~\citep{Rix}. We run SExtractor twice, once with a configuration optimized for the detection of only the brightest objects ("cold"), and then again with a configuration optimized for the faint objects ("hot" step). The higher detection threshold of the bright step improves the detection of close pairs. Masks are created to remove false detections around bright objects, and then the two samples are merged to form the final catalog.

The Sextractor configuration parameters used for the detection of bright and faint objects are shown in \autoref{table:s_param}. 
All other parameters are set to their default values. We will refer to the resultant catalogs of detected objects as $\rm C_{bright}$ and $\rm C_{faint}$. The segementation maps created in each step are saved, to be used later when the two catalogs are merged, as well as in creating a combined segmentation map. 

%----------------------------------
\begin{table}[htb]
\centering
\caption{SExtractor configuration parameters for bright and faint object detection.}
\label{table:s_param}
\begin{tabular}{lll}
\hline
\hline
Parameter & Bright Objects  & Faint Objects  \\
\hline
DETECT\_MINAREA  &  140  & 18  \\
DETECT\_THRESH   &  2.2  & 1.0  \\
DEBLEND\_NTHRESH &  64   & 64 \\
DEBLEND\_MINCONT &  0.04 & 0.065\\
CLEAN\_PARAM     &  1.0  & 1.0 \\
BACK\_SIZE       &  400  & 100 \\
BACK\_FILTERSIZE &  5    & 3\\
BACKPHOTO\_TYPE  &  Local & Local\\
BACKPHOTO\_THICK &  200   & 200\\
\end{tabular}
\end{table}
%----------------------------------

\subsection{Merging Bright and Faint Catalogs}
\label{ssec:merge}
To remove spurious detections around bright objects, the region associated with each object in the segmentation map for the bright-object detections is extended by 15 pixels in all directions\footnote{For the COSMOS catalog of~\cite{Leauthaud2007}, a 20-pixel buffer was used around bright objects. We found that the narrower buffer remedied problems in a later step in which we combine segmentation maps; see \autoref{ssec:com_seg}.}; 
objects in the faint catalog ($\rm C_{faint}$) are then removed if their centroid lies within the extended region associated with a bright object.  
The final catalog is obtained by merging {\em all} objects in the bright catalog ($\rm C_{bright}$) with the remaining faint objects.

\subsection{Cleaning}
Care was taken to remove unreliable regions of images and false detections. 
The following regions were masked and objects detected within the regions were excluded from the final catalog.
\begin{itemize}
\item \textbf{Image edge}: Each ACS/WFC pointing consists of four slightly offset, dithered exposures, making detection less reliable near the boundaries of each tile where there are fewer than four input exposures. Because adjacent tiles overlap sufficiently, we are able to eliminate these regions near the boundaries without reducing the number of detected objects. 
Objects are included in the catalog only if their centroid lies within the area demarcated by the green box shown in the image on the right of \autoref{fig:mask}. The same area is used for all tiles and for both filters.
\item \textbf{Diffraction spikes}: Objects near bright stars or saturated pixels were masked to avoid shape biases due to any background gradient. Stars with magnitude less than 19 are taken to be saturated. An automatic algorithm was developed to define polygonal-shaped masks around saturated stars, with a size scaled by the FLUX\_AUTO of the star. The diffraction spike mask for a saturated star is shown as the yellow polygon in the image on the right in \autoref{fig:mask}. 
The width of the spike mask was set to 40 pixels. The length of the spike to be masked was determined with parameters from a linear fit that was made to FLUX\_AUTO versus the length of the spike measured manually, for 10 saturated stars. The angle was set as the mean of the angles that the manually measured spikes were found to be rotated relative to the $x$-$y$ axes. The parameters defining the mask were computed separately for each filter.

%----------------------------------
\begin{figure}[h]
  \centering
  \subfloat[Raw image.]{\includegraphics[width=0.5\textwidth]{im.png}}
  \hfill
  \subfloat[Boundary edge (green), automated diffraction spike mask (yellow), and manual mask (pink).]{\includegraphics[width=0.5\textwidth]{im_with_mask.png}}
\caption{(a) Raw image. (b) Examples of masking.}
  \label{fig:mask}
\end{figure}
%----------------------------------
\item \textbf{Manual masks}: In a few cases where the automatic diffraction-spike masking algorithm failed, the masks were corrected by hand. Other artifacts or contaminated regions were masked, including ``ghosts'' due to internal reflections. The pink boxes in the image on the right in \autoref{fig:mask} show two such regions that were discovered upon visual inspection and manually masked.
\item \textbf{Multiple detections}: Pairs of objects whose centroids are within 2 arcseconds of each other (typically due to the overlap between adjacent tiles) were marked as multiple detections. 
The object with the highest value of SExtractor FLAG (indicating a poor detection) was discarded;
if the the multiple detections have the same FLAG, the object with  higher SNR is kept.
\end{itemize}
This gives a catalog of around \num{136000} unique detections (see \autoref{table:count_all}). 

\subsection{Star Galaxy Separation}
Since the goal here is to obtain a sample of \textbf{galaxy} images in multiple bands, star-galaxy separation is important. 
Also, a clean sample of stars is important for modeling the PSF. 
The CLASS\_STAR parameter of SExtractor is unreliable since it was trained with ground-based images and is therefore only valid for a sample of profiles similar to the original training set ~\citep{Leauthaud2007}. Therefore, we use an  alternate method that was used in the COSMOS catalog construction to classify point sources and galaxies, based on the SExtractor parameters MU\_MAX (peak surface brightness above the background level) and MAG\_AUTO. 
Since the surface brightness of a point source scales with magnitude, and that of extended objects does not, stars occupy a well-defined locus in a MU\_MAX/MAG\_AUTO plane whereas galaxies do not.
The criteria used to classify stars and galaxies is illustrated by the black line in the plot for each filter in  \autoref{fig:star_gal}. 
Since point sources are difficult to separate from small faint galaxies, we only use star candidates with magnitudes less than 25. In the figure, the red dots denote stars and the blue dots galaxies. 

%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=1.\linewidth]{star_gal_04.png}
\caption{Star-galaxy separation in a plot of surface brightness versus magnitude, for V band (left) and I band (right) for a single tile. 
The black line shows the line used to separate stars and galaxies.
Faint objects with magnitude above 25 are not classified as stars due to contamination from galaxies.
The red dots denote star candidates while the blue dots denote galaxy candidates.  
The stars with yellow circle are stars selected for PSF estimation.}
\label{fig:star_gal}
\end{figure}
%----------------------------------

\subsection{PSF Estimation}
The ACS/WFC PSF is not as stable as one might hope for a space-based camera. Fortunately, most of the PSF variation can be ascribed to a single physical parameter. Thermal expansions and contractions of HST alter the distance between the primary and secondary mirrors. As the effective focus deviates from nominal, the PSF becomes larger and more elliptical, with the direction of elongation depending on the position above or below nominal focus. The {\tt Tiny Tim} ray-tracing program is used to create a grid of model PSF images at varying focus offsets \citep{Rhodes}. By comparing the ellipticity of $\approx 15$ stars in each image to the {\tt Tiny Tim} predictions for those locations, we determine the image's effective focus. 

The stars for PSF estimation were selected from the up-to-25 stars with highest SNR in each image. The closest "star" in the {\tt Tiny Tim} model for each of the above stars was identified. Of these, only stars that were 1) not masked, 2) had no other object close to them, 3) had a {\tt Tiny Tim} star within 200 pixels, and 4) were classified as stars in both bands were selected for PSF estimation. A cost function was defined as the sum of the squares of the differences in each ellipticity component for the real and simulated stars, where the ellipticity was defined in terms of the second moments. 
The focus offset was chosen as the one with the lowest cost function. 
A sample plot of cost function versus focus offset is shown in \autoref{fig:cf_foc}. 
The vertical dashed line shows the value of focus offset corresponding to the minimum cost function.

%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=0.8\linewidth]{cf_foc_04.png}
\caption{Cost function for different values of focus offset for V band (left) and I band (right). The vertical dashed line shows the selected focus offset value.}
\label{fig:cf_foc}
\end{figure}
%----------------------------------

For each image, the focus offset was calculated for all stars that passed the criteria described above, and then recalculated dropping the lowest SNR star. 
This was repeated until only 3 stars were left.
\autoref{fig:foc_num} shows the focus offset corresponding to the minimum value of the cost function for different numbers of stars used to compute the cost function, in a single sample image. 
The modal value of focus offset was selected for each image, illustrated with the horizontal dashed line in the image.
%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=0.8\linewidth]{foc_num_04.png}
\caption{Focus offset corresponding to minimum cost function for different numbers of stars used to calculate the cost function for V band (left) and I band (right).
The horizontal dashed line shows the focus offset selected.}
\label{fig:foc_num}
\end{figure}
%----------------------------------

\subsection{Combined Segmentation Map}
\label{ssec:com_seg}
Our main objective here is to obtain \textbf{individual} galaxy images in multiple bands -- i.e. individual postage stamps of galaxies. If there is more than one galaxy in a postage stamp, the cleaning step masks the non-central galaxies with noise. However if this masked object is too close to the central object, or if the masking was insufficient, they will be eliminated in the selection step.  Identifying these multiple galaxies is done with a segmentation map that includes all objects in the bright-faint merged catalog, hereafter called the combined segmentation map. Since we care more about obtaining a pure sample than a complete sample, the cleaning step has been made stringent. Eliminating  a few good galaxies to be removed in the selection step is preferable to having postage stamps with multiple objects  that cannot be cleaned. Thus even if an object doe not appear in the final catalog, it will be included in the combined segmentation map for cleaning.

There are several factors to be considered in making the combined segmentation map.
\begin{enumerate}
\item Every object in the catalog must have only one region. 
\item The detection limits and hence segmentation maps for bright and faint detections will be different. 
\item The combined map must try to not shred objects. 
\item Close-by objects should be identified as different regions.
\end{enumerate}

Bright/faint objects in the combined segmentation map will have a region corresponding to their region in the bright/faint segmentation map. If a pixel was detected to belong to different objects in the bright and faint step, it is assigned to the bright object. The original segmentation region corresponding to any object in the bright catalog is expanded by 5 pixels. This is done because detection limits were set much higher for the bright objects and the segmentation maps obtained thus do not encompass the whole object. 

As noted earlier (in \autoref{ssec:merge}), in the COSMOS reduction procedure, objects in the faint catalog are added to the merged catalog only if the center of the faint object does not lie inside the bright segment buffered by 20 pixels. Thus a small faint object that lies within this buffered region will not be included in the merged catalog and in the combined segmentation map; hence, it will not be replaced by noise in the cleaning step. This is why we decided to reduce the buffer size to 15 pixels. 

\subsection{Galaxy Selection}
\label{sec:gal_selection}
The following criteria are used to  select objects for the final catalog of galaxies and the corresponding set of postage stamps:
\begin{itemize}
\item The object is not classified as a star in either filter.
\item The object is not in a masked region in either filter.
\item The object has SNR $>0$ in both filters.
\item Object has MAG\_AUTO less than $25.2$ in the I (F814W) band. 
\end{itemize}

29,105 objects satisfy the above criteria (see \autoref{table:count_all}).

\subsection{Galaxy Postage Stamps}
%Only objects that satisfy the above criteria appear in the final catalog and have corresponding postage stamps. 
Rectangular postage stamps are made for each selected galaxy. 
The size of the postage stamp for each galaxy is
determined using equations 2 and 3 in \cite{Haussler2007}:
\begin{eqnarray}
{\rm XSIZE} & = 2.5\, a \, {\rm kron}\,\Big( |\sin\theta| + (1-{\rm ellip})|\cos\theta|\Big),\\
{\rm YSIZE} & = 2.5\, a \, {\rm kron}\,\Big( |\cos\theta| + (1-{\rm ellip})|\sin\theta|\Big),
\end{eqnarray}
where $a$ is the SExtractor output parameter A\_IMAGE, kron is KRON\_RADIUS, $\theta$ is THETA\_IMAGE, and ellip is ELLIPTICITY. XSIZE and YSIZE are individually computed for each filter and the highest value sets that dimension of the postage stamp for both filters.  
Postage stamps with the same dimensions are also drawn for the combined segmentation map and used in the cleaning step below.

\subsection{Cleaning the Postage Stamps}
\label{sec:cleanpostagestamps}
In crowded regions, the galaxy postage stamp may contain more than one object. 
All objects within a postage stamp are identified from the combined segmentation-map postage stamp for the galaxy on which the postage stamp is centered. 
Pixels that correspond to any object except the central object are identified and their values in the galaxy postage stamp are replaced with a noise map created for each filter using a method  described in the next subsection. 

Two quantities are saved and used (\autoref{sec:rem_bad_stamps}) later to identify bad postage stamps: 
1) the distance from the center of the postage stamp (i.e., the center of the selected object) to the closest pixel whose value was replaced with noise; 2) the average flux in the $3 \times 3$ pixel region around the closest replaced pixel, before replacing with noise.

\subsection{Creating the Noise Map}

The drizzling process introduces correlations between neighboring pixels, which artificially reduces the noise level of co-added drizzled images. Care is taken to preserve these correlations when generating noise maps to replace pixel values for nearby objects. 
 
Sixteen empty regions of varying sizes, with dimensions ranging from 70-700 pixels,  at different positions on the image plane, were visually identified. A $50\times50$ covariance matrix for the pixel values was calculated for each empty region (separately in each filter) and their mean computed, as shown in \autoref{fig:covar}.
Noise maps generated from the mean covariance matrix for each filter are shown in \autoref{fig:noise_map}.

%----------------------------------
\begin{figure}[h]
  \centering
  \subfloat[Covariance map in V (F606W) filter.]{\includegraphics[width=0.4\textwidth]{covar_f814.png}}
  \hfill
  \subfloat[Covariance map in I (F814W) filter.]{\includegraphics[width=0.4\textwidth]{covar_f606.png}}
  \caption{Mean co-variance matrix in the two filters.}
  \label{fig:covar}
\end{figure}
%----------------------------------

%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=1.\linewidth]{noise_map.png}
\caption{Image of noise map generated from covariance matrices, for I band (left) and V band (right).}
\label{fig:noise_map}
\end{figure}
%----------------------------------

To replace nearby objects with noise, a region that is identical in size and shape to the nearby object in the segmentation map is cut from a random location in the noise map shown in \autoref{fig:noise_map} and used to replace the pixel values for the nearby object in the galaxy postage stamp.  

\subsection{Parametric Fits}
The COSMOS catalog galaxies were subject to an additional step of fitting for parametric models. This step was not performed here, and the values in the output catalogs corresponding to them were manually set to 999.

\subsection{PSF Postage Stamp}
The PSF for each galaxy is taken to be the {\tt Tiny Tim} model PSF image whose location in the {\tt Tiny Tim} grid is closest to the galaxies position in the focal plane, for the best-fit focus offset described above.  Square postage stamps ($20 \times 20$ pixels) are drawn for each filter.

\subsection{Additional Catalogs}
The Extended Groth Strip (EGS) has been extensively studied with other surveys in other bands. 
We include in our catalog photometry and photometric redshift measurements from other catalogs, for objects in our catalog with a center within $1''$ of an object in the other catalog.

We include in our final catalog the photometric redshifts for 3763 matched galaxies from the DEEP2 galaxy redshift survey, Data Release 4 \citep{Newman2013}. 
The redshift distribution for these matched galaxies is shown in \autoref{fig:redshift}. 

%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=0.7\linewidth]{redshift.png}
\caption{Photometric redshifts for selected galaxies that also appear in the DEEP2 redshift survey.}
\label{fig:redshift}
\end{figure}
%----------------------------------
We also include in our catalog the results from the photometry catalog of the AEGIS field~\citep{Lotz2008}. 
We compare in \autoref{fig:cat_mag} the magnitude we measure with SExtractor to the magnitude in the AEGIS photometry catalog for 27,289 matched objects. The magnitudes of bright objects in the two catalogs are in good agreement. However  for larger magnitudes, there are a few objects that are measured to be fainter in the AEGIS photometric catalog than in this catalog.
%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=1.\linewidth]{cat_mag.png}
\caption{Magnitudes in AEGIS catalog plotted versus magnitudes calculated with SExtractor for this study.}
\label{fig:cat_mag}
\end{figure}
%----------------------------------
\section{Data Products}
\label{sec:data}
The output files are in the format expected by {\tt galsim.RealGalaxyCatalog}. The format of the output files and the saved attributes are explained in detail in the AEGIS catalog  \href{https://github.com/sowmyakth/true_gal_colors/blob/master/AEGIS_25.2_training_sample_readme.txt}{README} file. 
For each band, there are several output files:
\begin{enumerate}
\item Main catalog (hereafter referred to as the GalSim catalog);
\item Files with postage stamp images of galaxies;
\item Files with postage stamp images of PSF;
\item Catalog with information on parametric fits (step not performed here);
\item Catalog with information for selection cuts;
\item File with noise correlation function.
\end{enumerate}

The GalSim catalogs contain only select details about the galaxies. A complete catalog with more columns is also created which has all the columns in the GalSim catalog, parametric fits catalog, selection catalog, information from additional catalogs and other measured values from SExtractor. 

\section{Object Characteristics}
\label{sec:analysis} 
In \autoref{fig:mag_all}, we show the distribution of magnitudes computed by SExtractor in V and I band, and V$-$I color, as well as a color-magnitude plot, for the 29,105 objects in the final catalog. 
Recall from \autoref{sec:gal_selection} that a magnitude cut of 25.2 was made in the I band only.
%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=1.\linewidth]{AEGIS_magnitude.png}
\caption{Distributions for the 29,105 selected objects. a) Magnitude in V band and I band. b) Difference in magnitudes (V$-$I color).  c) V$-$I color vs.~I band magnitude.}
\label{fig:mag_all}
\end{figure}
%----------------------------------

In \autoref{fig:sn_ellip}, we show the SNR distribution in each band for the selected galaxies. 
The SNR was measured with an elliptical Gaussian filter matched to the galaxy profile with the {\tt HSM} module of {\tt GalSim}. 
This SNR calculation does not take into account the fact that the noise is correlated between pixels; hence the noise is under-estimated.  
The corrected SNR would be approximately half the values plotted here (see section 3.8 in \cite{Leauthaud2007}).

%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=0.9\linewidth]{sn_ellip_all.png}
\caption{Distribution of the galaxy flux SNR,  measured with an elliptical Gaussian filter.}
\label{fig:sn_ellip}
\end{figure}
%----------------------------------

In \autoref{fig:pstamps}, postage stamps are shown for the galaxy images (left) and the corresponding {\tt Tiny Tim} PSF images (right) for V band (top) and I band (bottom), for a sample galaxy. 
As noted in earlier sections, the size of the galaxy postage stamp is the same for the two filters, and the PSF postage stamps are always 20 pixel $\times$ 20 pixel squares. 

%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=1.\linewidth]{pstamps.png}
\caption{Postage stamps for the galaxy images (left) and the corresponding {\tt Tiny Tim} PSF images (right) for V band (top) and I band (bottom), for a sample galaxy.}
\label{fig:pstamps}
\end{figure}
%----------------------------------

\subsection{Identify Bad Postage Stamps}
\label{sec:rem_bad_stamps}
The postage stamp cleaning step (see \autoref{sec:cleanpostagestamps}) ensures that there is only one galaxy per postage stamp by replacing the other objects with noise. However, sometimes the other object is too close to the central galaxy or too bright for it to be effectively masked. These objects are included in the final catalog. However, we identify these bad stamps with the  {\tt exclusion\_level=bad\_stamp} flag in the {\tt galsim.COSMOSCatalog} module. 
The bad stamp flag is {\em not} set if
\begin{enumerate}
\item the closest replaced pixel is more than than 11 pixels from the center of the central galaxy
and the flux in the region adjacent to the closest replaced pixel is less than 0.8 times the peak of the central object;
\item the SNR of the central galaxy measured with an elliptical Gaussian filter, is greater than 12.
\end{enumerate}
We are left with 27,392 galaxies that do not have the bad flag set in either filter. 

Even with the above mentioned selection criteria, some bad postage stamps will remain in the final sample. We show examples in \autoref{fig:bad}. In the left image, a sharp straight boundary marks where a neighboring object was replaced with noise. In the right postage stamp, we see two objects, but SExtractor found only a single object. The impact on shear measurements of objects such as these will need to be monitored.
%---------------------------------
\begin{figure}[h]
\centering\includegraphics[width=1.\linewidth]{bad.png}
\caption{Two bad postage stamps that passed the COSMOSCatalog selection criteria.}
\label{fig:bad}
\end{figure}
%----------------------------------
\section{Future Work}
This work was done with the intention of obtaining real galaxy images in the two AEGIS HST bands to produce realistic chromatic galaxy images as would be seen by other surveys. However, the pipeline can be used to reduce any HST images in multiple bands -- e.g., the CANDELS survey. Parametric fits can be performed on the galaxies and studied. The images can also be used for the analysis of multi-band galaxy fits.

%\bibliographystyle{astroads.bst}
\bibliographystyle{apj.bst}
\bibliography{AEGIS}
%----------------------------------
%APPENDIX
\newpage
\begin{appendices}
\section{Weight Maps as Input to SExtractor} \label{App:weight}
SExtractor handles images with variable noise through weight maps, which describe the expected noise level at each pixel. These maps are internally stored in units of absolute variance (in ADU$^2$). Several types of weight maps can be input to SExtractor, which converts the map to its internal variance format, controlled through the WEIGHT\_TYPE configuration keyword. If a variance map is given as input -- i.e., WEIGHT\_TYPE is MAP\_VAR -- then the input file is assumed to contain a weight map in units of {\em relative} variance. A robust scaling to the appropriate {\em absolute} variance is then performed by comparing this variance map to an internal, low-resolution, absolute variance map built from the science image itself. 
If WEIGHT\_TYPE is MAP\_WEIGHT, then the specified FITS image must contain a weight map in units of relative weights (proportional to the inverse of the variance). The data are converted to variance units ($\propto$ 1/weight) and scaled as for MAP\_VAR. 
Finally, if WEIGHT\_TYPE is MAP\_RMS, then the input map must be in units of absolute standard deviations (in ADUs per pixel). (See Section 8 in the  \href{http://www.astromatic.net/pubsvn/software/sextractor/trunk/doc/sextractor.pdf}{SExtractor manual} for details.)

Now the AEGIS weight map from MultiDrizzle is produced with weight type MAP\_WEIGHT, but with {\em absolute} units. Since  SExtractor assumes MAP\_WEIGHT (and MAP\_VAR) weight types to be in {\em relative units}, 
we save the square root of the reciprocal of each weight map pixel in a new weight map and set the weight type to MAP\_RMS so that 
no normalization is performed by SExtractor. 
\end{appendices}
\end{document}

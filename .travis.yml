branches:
    only:
        - master

language: python
python:
    - 2.7

compiler:
    - g++
before_install:
    - export PATH=$(echo $PATH | tr ':' "\n" | sed '/\/opt\/python/d' | tr "\n" ":" | sed "s|::|:|g")
    - sudo apt-get -qq update
    - sudo apt-get install -y libboost-all-dev gfortran liblapack-dev libfftw3-dev python-dev python-numpy python-scipy python-nose

    # To get coverage of the WCSToolsWCS class:
    - sudo apt-get install -y wcstools

    # Only get TMV if not cached
    - pushd $HOME
    - if ! test -d tmv-0.73 || ! test -f tmv-0.73/Sconstruct; then wget https://github.com/rmjarvis/tmv/archive/v0.73.tar.gz && tar -xf v0.73.tar.gz ; else echo Using cached TMV; fi
    # But always install it to /usr/local
    - cd tmv-0.73 && sudo scons install DEBUG=True FLAGS="-O0"
    - popd

    # Add ~/bin and ~/lib to the appropriate paths where scons install will put things.
    - export PATH=$HOME/bin:$PATH
    - export LD_LIBRARY_PATH=$HOME/lib:$LD_LIBRARY_PATH

cache:
    pip: true
    directories:
    - $HOME/tmv-0.73

install:
    - pip install astropy==1.1.1 pyyaml future coveralls starlink-pyast
    - scons PREFIX=$HOME
    - scons install

script:
    - cd tests
    # Use this rather than scons tests, so we can get the coverage options.
    - "nosetests test*.py --with-coverage --cover-package=galsim --with-doctest --cover-erase"
    # Without cover-erase, this will append to the .coverage file
    - "nosetests run_examples.py --with-coverage --cover-package=galsim --with-doctest"

after_success:
    # The multiprocessing stages don't get properly incorporated into the .coverage file unless
    # we do this command.  (Some of the .coverage.* files are in the ../examples directory.)
    - coverage combine . ../examples

    # If we start doing multiple python versions here, then only report coveralls for one of them.
    # Otherwise the reported results get weird.
    - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then coveralls; fi

